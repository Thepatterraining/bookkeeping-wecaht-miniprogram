---
ruleType: Model Request
description: 影响范围分析
globs:
---

### 影响范围分析

在技术方案设计完成后，为QA团队生成详细的影响范围分析报告，帮助制定全面的测试策略。

**执行时机**：
- 方案设计完成并获得用户批准后
- 任务创建之前
- 作为独立阶段或方案设计阶段的补充

**约束条件：**

- 模型 **必须** 基于已完成的设计文档进行影响范围分析
- 若尚不存在，模型 **必须** 创建文件 `.spec/{feature_name}/impact_analysis.md`
- 模型 **必须** 深入分析代码调用链，识别所有可能受影响的系统入口
- 模型 **必须** 使用代码搜索工具确保分析的准确性和完整性
- 影响范围分析 **必须** 包含以下章节：
  - 直接影响分析（Direct Impact）
  - 间接影响分析（Indirect Impact）
  - 数据层影响（Data Layer Impact）
  - 服务依赖影响（Service Dependency Impact）
  - QA测试建议（QA Testing Recommendations）

**直接影响分析要求：**
- 模型 **必须** 识别所有被直接修改的服务入口，包括但不限于：
  - **HTTP入口**：REST API接口，包括路径、方法、控制器类
  - **MTThrift入口**：Thrift服务接口，包括服务名、方法名
  - **Crane定时任务入口**：定时任务配置，包括任务名、执行类
  - **MafKa MQ入口**：消息队列消费者，包括Topic、Consumer Group
  - **其他入口**：不属于上述类型的入口
- 对每个入口，模型 **必须** 提供：
  - 入口标识（类名、方法名、路径等）
  - 修改类型（新增/修改/删除）
  - 影响程度（高/中/低）

**间接影响分析要求：**
- 模型 **必须** 通过代码调用链分析，识别间接受影响的入口
- 模型 **必须** 分析以下调用关系：
  - 调用被修改组件的上层服务
  - 被修改组件调用的下层服务
  - 共享数据模型的相关组件
- 模型 **应当** 使用codebase_search和grep_search工具验证调用关系

**数据层影响分析要求：**
- 模型 **必须** 识别所有受影响的数据存储，包括：
  - **数据库表**：新增/修改的表结构、索引变更
  - **缓存**：Redis缓存key变更、缓存策略调整
  - **消息队列**：新增/Topic、消息格式变更
- 模型 **必须** 分析数据兼容性影响

**服务依赖影响分析要求：**
- 模型 **必须** 识别上下游服务的影响：
  - **上游调用方**：哪些服务会调用被修改的接口
  - **下游被调用方**：被修改组件会调用哪些外部服务
  - **配置依赖**：Lion配置、环境变量等变更影响

**QA测试建议要求：**
- 模型 **必须** 基于影响范围分析，为QA提供具体的测试建议：
  - **功能测试范围**：需要测试的具体接口和场景
  - **回归测试范围**：需要回归的相关功能点
  - **性能测试建议**：如有性能相关改动，提供性能测试建议
  - **数据测试建议**：数据一致性、兼容性测试要点
  - **集成测试建议**：跨服务、跨系统的集成测试要点

**输出格式要求：**
- 模型 **必须** 使用清晰的表格和列表格式，便于QA快速理解
- 模型 **应当** 使用图表展示调用关系和影响范围
- 模型 **必须** 按影响程度对各项进行优先级排序
- 模型 **必须** 提供具体的代码位置和配置位置引用

**版本管理和审批：**
- 模型 **必须** 遵循相同的版本管理规则
- 影响范围分析完成后，模型 **必须** 询问用户："影响范围分析看起来可以吗？如果可以，我们就进入任务创建阶段。"
- 模型 **必须** 获得明确批准后才能继续

**质量检查要求：**
- 模型 **必须** 确保分析的完整性，不遗漏任何可能的影响点
- 模型 **应当** 通过代码搜索验证分析结果的准确性
- 模型 **必须** 确保QA测试建议的可操作性和实用性
- 若发现影响范围超出预期，模型 **应当** 建议重新评估方案设计

**与现有流程的集成：**
- 在tech_design.md规则中，模型 **必须** 在设计批准后自动进入影响范围分析
- 在task.md规则中，模型 **必须** 基于影响范围分析结果创建相应的测试任务
- 影响范围分析作为设计文档的重要补充，帮助完善整体技术方案
